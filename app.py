# This file generated by Quarto; do not edit by hand.
# shiny_mode: core

from __future__ import annotations

from pathlib import Path
from shiny import App, Inputs, Outputs, Session, ui




def server(input: Inputs, output: Outputs, session: Session) -> None:
    # ---------------------------------
    # íŒ¨í‚¤ì§€ ë¡œë“œ
    # ---------------------------------
    import pandas as pd
    import numpy as np
    import matplotlib.pyplot as plt
    from shiny.express import ui, input, render
    from shinywidgets import output_widget, render_widget
    import plotly.graph_objects as go

    # í•œê¸€ í°íŠ¸ ì„¤ì •
    plt.rcParams['font.family'] = 'Malgun Gothic'
    plt.rcParams['axes.unicode_minus'] = False

    # ---------------------------------
    # ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
    # ---------------------------------
    center_lat, center_lon = 36.8195, 127.1135
    df_cctv = pd.DataFrame()
    df_kick = pd.DataFrame()
    df_school = pd.DataFrame()
    df_lamp = pd.DataFrame()

    # ---------------------------------
    # ë°ì´í„° ë¡œë“œ
    # ---------------------------------
    try:
        df4 = pd.read_csv('cctvìµœì¢…ë°ì´í„°.csv') 
        df6 = pd.read_excel('kickrani.xlsx', header=1)
        df5 = pd.read_csv('í•™êµìµœì¢…ë°ì´í„°.csv')
        df_000 = pd.read_csv('ê°€ë¡œë“±ìœ„í—˜ë„ìµœì¢…ë°ì´í„°.csv')
    
        # ë°ì´í„° ì „ì²˜ë¦¬
        if not df4.empty and 'ìœ„ë„' in df4.columns and 'ê²½ë„' in df4.columns:
            df_cctv = df4[['ìœ„ë„', 'ê²½ë„']].dropna()
    
        if not df6.empty and 'ìœ„ë„' in df6.columns and 'ê²½ë„' in df6.columns:
            df_kick = df6[['ìœ„ë„', 'ê²½ë„', 'ì£¼ì°¨ê°€ëŠ¥ ëŒ€ìˆ˜']].dropna()
    
        if not df5.empty and 'lat' in df5.columns and 'lon' in df5.columns:
            df_school = df5[['lat', 'lon', 'êµ¬ë¶„']].dropna()
    
        if not df_000.empty and 'ìœ„ë„' in df_000.columns and 'ê²½ë„' in df_000.columns:
            df_lamp = df_000[['ìœ„ë„', 'ê²½ë„', 'ì„¤ì¹˜í˜•íƒœ', 'ìœ„í—˜ë„(100ì )']].dropna()
            # ì¤‘ì‹¬ ì¢Œí‘œ ì—…ë°ì´íŠ¸
            if not df_lamp.empty:
                center_lat = df_lamp['ìœ„ë„'].mean()
                center_lon = df_lamp['ê²½ë„'].mean()
    
        print(f"ë°ì´í„° ë¡œë“œ ì™„ë£Œ:")
        print(f"ê°€ë¡œë“±: {len(df_lamp)}ê°œ")
        print(f"CCTV: {len(df_cctv)}ê°œ") 
        print(f"í•™êµ: {len(df_school)}ê°œ")
        print(f"í‚¥ë¼ë‹ˆ: {len(df_kick)}ê°œ")
    
    except Exception as e:
        print(f"ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")

    # ---------------------------------
    # UI êµ¬ì„±
    # ---------------------------------
    with ui.sidebar():
        ui.h2("ğŸ—ºï¸ ë ˆì´ì–´ ì„ íƒ")
    
        ui.h4("ê¸°ë³¸ ì‹œì„¤")
        ui.input_checkbox_group(
            "basic_layers",
            "í‘œì‹œí•  ì‹œì„¤:",
            choices={
                "lamp": "ğŸŸ¡ ê°€ë¡œë“±",
                "cctv": "ğŸŸ¢ CCTV", 
                "school": "ğŸŸ£ í•™êµ",
                "kick": "âš« í‚¥ë¼ë‹ˆ ì£¼ì°¨ì¥"
            },
            selected=["lamp"]
        )
    
        ui.hr()
    
        ui.h4("ìœ„í—˜ë„ë³„ ë¶„ì„")
        ui.input_checkbox_group(
            "risk_layers",
            "ìœ„í—˜ë„ êµ¬ì—­:",
            choices={
                "high_risk": "ğŸ”´ ê³ ìœ„í—˜ (80ì  ì´ìƒ)",
                "medium_risk": "ğŸŸ  ì¤‘ìœ„í—˜ (60-79ì )",
                "safe": "ğŸ”µ ì•ˆì „ (30-40ì )"
            },
            selected=[]
        )
    
        ui.hr()
    
        ui.h4("ì§€ë„ ì„¤ì •")
        ui.input_slider(
            "map_zoom",
            "í™•ëŒ€/ì¶•ì†Œ:",
            min=10,
            max=16,
            value=12,
            step=1
        )

    # ë©”ì¸ ì»¨í…ì¸ 
    with ui.layout_columns(col_widths=[12]):
        with ui.card():
            ui.card_header("ì²œì•ˆì‹œ ì‹œì„¤ë¬¼ ë° ë„ë¡œ ìœ„í—˜ë„ í˜„í™©")
            output_widget("main_map")

    with ui.layout_columns(col_widths=[6, 6]):
        with ui.card():
            ui.card_header("ğŸ“Š ë°ì´í„° ìš”ì•½")
            @render.text
            def data_summary():
                summary = []
                if not df_lamp.empty:
                    summary.append(f"ğŸŸ¡ ê°€ë¡œë“±: {len(df_lamp):,}ê°œ")
                if not df_cctv.empty:
                    summary.append(f"ğŸŸ¢ CCTV: {len(df_cctv):,}ê°œ")
                if not df_school.empty:
                    summary.append(f"ğŸŸ£ í•™êµ: {len(df_school):,}ê°œ")
                if not df_kick.empty:
                    summary.append(f"âš« í‚¥ë¼ë‹ˆ: {len(df_kick):,}ê°œ")
            
                return "\n".join(summary) if summary else "ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
        with ui.card():
            ui.card_header("âš ï¸ ìœ„í—˜ë„ ë¶„í¬")
            @render.text
            def risk_summary():
                if df_lamp.empty:
                    return "ê°€ë¡œë“± ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
            
                high_risk = len(df_lamp[df_lamp['ìœ„í—˜ë„(100ì )'] >= 80])
                medium_risk = len(df_lamp[(df_lamp['ìœ„í—˜ë„(100ì )'] >= 60) & (df_lamp['ìœ„í—˜ë„(100ì )'] < 80)])
                safe = len(df_lamp[(df_lamp['ìœ„í—˜ë„(100ì )'] >= 30) & (df_lamp['ìœ„í—˜ë„(100ì )'] <= 40)])
            
                return f"""ğŸ”´ ê³ ìœ„í—˜ (80ì  ì´ìƒ): {high_risk:,}ê°œ
    ğŸŸ  ì¤‘ìœ„í—˜ (60-79ì ): {medium_risk:,}ê°œ  
    ğŸ”µ ì•ˆì „ (30-40ì ): {safe:,}ê°œ
    ğŸ“Š í‰ê·  ìœ„í—˜ë„: {df_lamp['ìœ„í—˜ë„(100ì )'].mean():.1f}ì """

    # ---------------------------------
    # ë©”ì¸ ì§€ë„ ë Œë”ë§
    # ---------------------------------
    @render_widget
    def main_map():
        fig = go.Figure()
    
        # ê¸°ë³¸ ì§€ë„ì— ìµœì†Œí•œ í•˜ë‚˜ì˜ ì ì€ í‘œì‹œ (ì²œì•ˆì‹œì²­)
        fig.add_trace(go.Scattermapbox(
            lat=[center_lat],
            lon=[center_lon],
            mode='markers',
            marker=dict(size=12, color='red', symbol='town-hall'),
            text='ì²œì•ˆì‹œì²­',
            name='ì²œì•ˆì‹œì²­',
            hovertemplate='<b>ì²œì•ˆì‹œì²­</b><br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
        ))
    
        # ì„ íƒëœ ë ˆì´ì–´ë“¤
        basic_layers = set(input.basic_layers())
        risk_layers = set(input.risk_layers())
    
        # ê°€ë¡œë“± (ê¸°ë³¸)
        if "lamp" in basic_layers and not df_lamp.empty:
            fig.add_trace(go.Scattermapbox(
                lat=df_lamp['ìœ„ë„'],
                lon=df_lamp['ê²½ë„'],
                mode='markers',
                marker=dict(size=6, color='yellow', opacity=0.6),
                text=df_lamp['ì„¤ì¹˜í˜•íƒœ'].astype(str) + '<br>ìœ„í—˜ë„: ' + df_lamp['ìœ„í—˜ë„(100ì )'].astype(str),
                name='ğŸŸ¡ ê°€ë¡œë“±',
                hovertemplate='<b>ê°€ë¡œë“±</b><br>ì„¤ì¹˜í˜•íƒœ: %{text}<br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
            ))
    
        # CCTV
        if "cctv" in basic_layers and not df_cctv.empty:
            fig.add_trace(go.Scattermapbox(
                lat=df_cctv['ìœ„ë„'],
                lon=df_cctv['ê²½ë„'],
                mode='markers',
                marker=dict(size=8, color='green', opacity=0.7),
                name='ğŸŸ¢ CCTV',
                hovertemplate='<b>CCTV</b><br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
            ))
    
        # í•™êµ
        if "school" in basic_layers and not df_school.empty:
            fig.add_trace(go.Scattermapbox(
                lat=df_school['lat'],
                lon=df_school['lon'],
                mode='markers',
                marker=dict(size=10, color='purple', opacity=0.7),
                text=df_school['êµ¬ë¶„'].astype(str),
                name='ğŸŸ£ í•™êµ',
                hovertemplate='<b>í•™êµ</b><br>êµ¬ë¶„: %{text}<br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
            ))
    
        # í‚¥ë¼ë‹ˆ ì£¼ì°¨ì¥
        if "kick" in basic_layers and not df_kick.empty:
            fig.add_trace(go.Scattermapbox(
                lat=df_kick['ìœ„ë„'],
                lon=df_kick['ê²½ë„'],
                mode='markers',
                marker=dict(size=10, color='black', opacity=0.7),
                text='ì£¼ì°¨ê°€ëŠ¥: ' + df_kick['ì£¼ì°¨ê°€ëŠ¥ ëŒ€ìˆ˜'].astype(str) + 'ëŒ€',
                name='âš« í‚¥ë¼ë‹ˆ',
                hovertemplate='<b>í‚¥ë¼ë‹ˆ ì£¼ì°¨ì¥</b><br>%{text}<br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
            ))
    
        # ìœ„í—˜ë„ë³„ ë¶„ì„ ë ˆì´ì–´
        if not df_lamp.empty:
            # ê³ ìœ„í—˜ êµ¬ì—­
            if "high_risk" in risk_layers:
                df_high_risk = df_lamp[df_lamp['ìœ„í—˜ë„(100ì )'] >= 80]
                if not df_high_risk.empty:
                    fig.add_trace(go.Scattermapbox(
                        lat=df_high_risk['ìœ„ë„'],
                        lon=df_high_risk['ê²½ë„'],
                        mode='markers',
                        marker=dict(size=12, color='red', opacity=0.8),
                        text='ìœ„í—˜ë„: ' + df_high_risk['ìœ„í—˜ë„(100ì )'].astype(str),
                        name='ğŸ”´ ê³ ìœ„í—˜êµ¬ì—­',
                        hovertemplate='<b>ê³ ìœ„í—˜êµ¬ì—­</b><br>%{text}ì <br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
                    ))
        
            # ì¤‘ìœ„í—˜ êµ¬ì—­
            if "medium_risk" in risk_layers:
                df_medium_risk = df_lamp[(df_lamp['ìœ„í—˜ë„(100ì )'] >= 60) & (df_lamp['ìœ„í—˜ë„(100ì )'] < 80)]
                if not df_medium_risk.empty:
                    fig.add_trace(go.Scattermapbox(
                        lat=df_medium_risk['ìœ„ë„'],
                        lon=df_medium_risk['ê²½ë„'],
                        mode='markers',
                        marker=dict(size=10, color='orange', opacity=0.7),
                        text='ìœ„í—˜ë„: ' + df_medium_risk['ìœ„í—˜ë„(100ì )'].astype(str),
                        name='ğŸŸ  ì¤‘ìœ„í—˜êµ¬ì—­',
                        hovertemplate='<b>ì¤‘ìœ„í—˜êµ¬ì—­</b><br>%{text}ì <br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
                    ))
        
            # ì•ˆì „ êµ¬ì—­
            if "safe" in risk_layers:
                df_safe_zone = df_lamp[(df_lamp['ìœ„í—˜ë„(100ì )'] >= 30) & (df_lamp['ìœ„í—˜ë„(100ì )'] <= 40)]
                if not df_safe_zone.empty:
                    fig.add_trace(go.Scattermapbox(
                        lat=df_safe_zone['ìœ„ë„'],
                        lon=df_safe_zone['ê²½ë„'],
                        mode='markers',
                        marker=dict(size=10, color='blue', opacity=0.7),
                        text='ìœ„í—˜ë„: ' + df_safe_zone['ìœ„í—˜ë„(100ì )'].astype(str),
                        name='ğŸ”µ ì•ˆì „êµ¬ì—­',
                        hovertemplate='<b>ì•ˆì „êµ¬ì—­</b><br>%{text}ì <br>ìœ„ë„: %{lat}<br>ê²½ë„: %{lon}<extra></extra>'
                    ))
    
        # ì§€ë„ ë ˆì´ì•„ì›ƒ ì—…ë°ì´íŠ¸
        fig.update_layout(
            mapbox_style="open-street-map",
            mapbox_zoom=input.map_zoom(),
            mapbox_center={"lat": center_lat, "lon": center_lon},
            height=600,
            margin={"r": 0, "t": 30, "l": 0, "b": 0},
            legend=dict(
                title="ë²”ë¡€",
                orientation="v",
                yanchor="top",
                y=0.99,
                xanchor="left",
                x=0.01,
                bgcolor="rgba(255,255,255,0.8)"
            )
        )
    
        return fig

    # ========================================================================



    return None


_static_assets = ##STATIC_ASSETS_PLACEHOLDER##
_static_assets = {"/" + sa: Path(__file__).parent / sa for sa in _static_assets}

app = App(
    Path(__file__).parent / "test.html",
    server,
    static_assets=_static_assets,
)
